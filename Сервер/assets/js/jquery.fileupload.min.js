(function(a){if(typeof define==="function"&&define.amd){define(["jquery","jquery.ui.widget"],a)}else{a(window.jQuery)}}(function(a){a.support.xhrFileUpload=!!(window.XMLHttpRequestUpload&&window.FileReader);a.support.xhrFormDataFileUpload=!!window.FormData;a.widget("blueimp.fileupload",{options:{dropZone:a(document),pasteZone:a(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,sequentialUploads:false,limitConcurrentUploads:undefined,forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,autoUpload:true,formData:function(b){return b.serializeArray()},add:function(c,b){if(b.autoUpload||(b.autoUpload!==false&&(a(this).data("blueimp-fileupload")||a(this).data("fileupload")).options.autoUpload)){b.submit()}},processData:false,contentType:false,cache:false},_refreshOptionsList:["fileInput","dropZone","pasteZone","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+(new Date());this.loaded=0;this.bitrate=0;this.getBitrate=function(d,c,b){var e=d-this.timestamp;if(!this.bitrate||!b||e>b){this.bitrate=(c-this.loaded)*(1000/e)*8;this.loaded=c;this.timestamp=d}return this.bitrate}},_isXHRUpload:function(b){return !b.forceIframeTransport&&((!b.multipart&&a.support.xhrFileUpload)||a.support.xhrFormDataFileUpload)},_getFormData:function(c){var b;if(typeof c.formData==="function"){return c.formData(c.form)}if(a.isArray(c.formData)){return c.formData}if(c.formData){b=[];a.each(c.formData,function(d,e){b.push({name:d,value:e})});return b}return[]},_getTotal:function(b){var c=0;a.each(b,function(e,d){c+=d.size||1});return c},_initProgressObject:function(b){b._progress={loaded:0,total:0,bitrate:0}},_onProgress:function(c,b){if(c.lengthComputable){var f=+(new Date()),d;if(b._time&&b.progressInterval&&(f-b._time<b.progressInterval)&&c.loaded!==c.total){return}b._time=f;d=Math.floor(c.loaded/c.total*(b.chunkSize||b._progress.total))+(b.uploadedBytes||0);this._progress.loaded+=(d-b._progress.loaded);this._progress.bitrate=this._bitrateTimer.getBitrate(f,this._progress.loaded,b.bitrateInterval);b._progress.loaded=b.loaded=d;b._progress.bitrate=b.bitrate=b._bitrateTimer.getBitrate(f,d,b.bitrateInterval);this._trigger("progress",c,b);this._trigger("progressall",c,this._progress)}},_initProgressListener:function(b){var c=this,d=b.xhr?b.xhr():a.ajaxSettings.xhr();if(d.upload){a(d.upload).bind("progress",function(f){var g=f.originalEvent;f.lengthComputable=g.lengthComputable;f.loaded=g.loaded;f.total=g.total;c._onProgress(f,b)});b.xhr=function(){return d}}},_initXHRData:function(e){var c,b=e.files[0],d=e.multipart||!a.support.xhrFileUpload,f=e.paramName[0];e.headers=e.headers||{};if(e.contentRange){e.headers["Content-Range"]=e.contentRange}if(!d){e.headers["Content-Disposition"]='attachment; filename="'+encodeURI(b.name)+'"';e.contentType=b.type;e.data=e.blob||b}else{if(a.support.xhrFormDataFileUpload){if(e.postMessage){c=this._getFormData(e);if(e.blob){c.push({name:f,value:e.blob})}else{a.each(e.files,function(h,g){c.push({name:e.paramName[h]||f,value:g})})}}else{if(e.formData instanceof FormData){c=e.formData}else{c=new FormData();a.each(this._getFormData(e),function(h,g){c.append(g.name,g.value)})}if(e.blob){e.headers["Content-Disposition"]='attachment; filename="'+encodeURI(b.name)+'"';c.append(f,e.blob,b.name)}else{a.each(e.files,function(h,g){if((window.Blob&&g instanceof Blob)||(window.File&&g instanceof File)){c.append(e.paramName[h]||f,g,g.name)}})}}e.data=c}}e.blob=null},_initIframeSettings:function(b){b.dataType="iframe "+(b.dataType||"");b.formData=this._getFormData(b);if(b.redirect&&a("<a></a>").prop("href",b.url).prop("host")!==location.host){b.formData.push({name:b.redirectParamName||"redirect",value:b.redirect})}},_initDataSettings:function(b){if(this._isXHRUpload(b)){if(!this._chunkedUpload(b,true)){if(!b.data){this._initXHRData(b)}this._initProgressListener(b)}if(b.postMessage){b.dataType="postmessage "+(b.dataType||"")}}else{this._initIframeSettings(b,"iframe")}},_getParamName:function(c){var b=a(c.fileInput),d=c.paramName;if(!d){d=[];b.each(function(){var f=a(this),g=f.prop("name")||"files[]",e=(f.prop("files")||[1]).length;while(e){d.push(g);e-=1}});if(!d.length){d=[b.prop("name")||"files[]"]}}else{if(!a.isArray(d)){d=[d]}}return d},_initFormSettings:function(b){if(!b.form||!b.form.length){b.form=a(b.fileInput.prop("form"));if(!b.form.length){b.form=a(this.options.fileInput.prop("form"))}}b.paramName=this._getParamName(b);if(!b.url){b.url=b.form.prop("action")||location.href}b.type=(b.type||b.form.prop("method")||"").toUpperCase();if(b.type!=="POST"&&b.type!=="PUT"&&b.type!=="PATCH"){b.type="POST"}if(!b.formAcceptCharset){b.formAcceptCharset=b.form.attr("accept-charset")}},_getAJAXSettings:function(b){var c=a.extend({},this.options,b);this._initFormSettings(c);this._initDataSettings(c);return c},_getDeferredState:function(b){if(b.state){return b.state()}if(b.isResolved()){return"resolved"}if(b.isRejected()){return"rejected"}return"pending"},_enhancePromise:function(b){b.success=b.done;b.error=b.fail;b.complete=b.always;return b},_getXHRPromise:function(f,c,b){var d=a.Deferred(),e=d.promise();c=c||this.options.context||e;if(f===true){d.resolveWith(c,b)}else{if(f===false){d.rejectWith(c,b)}}e.abort=d.promise;return this._enhancePromise(e)},_addConvenienceMethods:function(c,b){var d=this;b.submit=function(){if(this.state()!=="pending"){b.jqXHR=this.jqXHR=(d._trigger("submit",c,this)!==false)&&d._onSend(c,this)}return this.jqXHR||d._getXHRPromise()};b.abort=function(){if(this.jqXHR){return this.jqXHR.abort()}return this._getXHRPromise()};b.state=function(){if(this.jqXHR){return d._getDeferredState(this.jqXHR)}};b.progress=function(){return this._progress}},_getUploadedBytes:function(b){var d=b.getResponseHeader("Range"),c=d&&d.split("-"),e=c&&c.length>1&&parseInt(c[1],10);return e&&e+1},_chunkedUpload:function(g,j){var k=this,c=g.files[0],d=c.size,l=g.uploadedBytes=g.uploadedBytes||0,f=g.maxChunkSize||d,i=c.slice||c.webkitSlice||c.mozSlice,b=a.Deferred(),h=b.promise(),e,m;if(!(this._isXHRUpload(g)&&i&&(l||f<d))||g.data){return false}if(j){return true}if(l>=d){c.error="Uploaded bytes exceed file size";return this._getXHRPromise(false,g.context,[null,"error",c.error])}m=function(){var p=a.extend({},g),n=p._progress.loaded;p.blob=i.call(c,l,l+f,c.type);p.chunkSize=p.blob.size;p.contentRange="bytes "+l+"-"+(l+p.chunkSize-1)+"/"+d;k._initXHRData(p);k._initProgressListener(p);e=((k._trigger("chunksend",null,p)!==false&&a.ajax(p))||k._getXHRPromise(false,p.context)).done(function(q,r,o){l=k._getUploadedBytes(o)||(l+p.chunkSize);if(p._progress.loaded===n){k._onProgress(a.Event("progress",{lengthComputable:true,loaded:l-p.uploadedBytes,total:l-p.uploadedBytes}),p)}g.uploadedBytes=p.uploadedBytes=l;p.result=q;p.textStatus=r;p.jqXHR=o;k._trigger("chunkdone",null,p);k._trigger("chunkalways",null,p);if(l<d){m()}else{b.resolveWith(p.context,[q,r,o])}}).fail(function(q,r,o){p.jqXHR=q;p.textStatus=r;p.errorThrown=o;k._trigger("chunkfail",null,p);k._trigger("chunkalways",null,p);b.rejectWith(p.context,[q,r,o])})};this._enhancePromise(h);h.abort=function(){return e.abort()};m();return h},_beforeSend:function(c,b){if(this._active===0){this._trigger("start");this._bitrateTimer=new this._BitrateTimer();this._progress.loaded=this._progress.total=0;this._progress.bitrate=0}if(!b._progress){b._progress={}}b._progress.loaded=b.loaded=b.uploadedBytes||0;b._progress.total=b.total=this._getTotal(b.files)||1;b._progress.bitrate=b.bitrate=0;this._active+=1;this._progress.loaded+=b.loaded;this._progress.total+=b.total},_onDone:function(d,e,b,c){var f=c._progress.total;if(c._progress.loaded<f){this._onProgress(a.Event("progress",{lengthComputable:true,loaded:f,total:f}),c)}c.result=d;c.textStatus=e;c.jqXHR=b;this._trigger("done",null,c)},_onFail:function(c,e,b,d){d.jqXHR=c;d.textStatus=e;d.errorThrown=b;this._trigger("fail",null,d);if(d.recalculateProgress){this._progress.loaded-=d._progress.loaded;this._progress.total-=d._progress.total}},_onAlways:function(c,e,b,d){this._active-=1;this._trigger("always",null,d);if(this._active===0){this._trigger("stop")}},_onSend:function(d,c){if(!c.submit){this._addConvenienceMethods(d,c)}var k=this,f,b,j,h,g=k._getAJAXSettings(c),i=function(){k._sending+=1;g._bitrateTimer=new k._BitrateTimer();f=f||(((b||k._trigger("send",d,g)===false)&&k._getXHRPromise(false,g.context,b))||k._chunkedUpload(g)||a.ajax(g)).done(function(l,m,e){k._onDone(l,m,e,g)}).fail(function(l,m,e){k._onFail(l,m,e,g)}).always(function(l,n,e){k._sending-=1;k._onAlways(l,n,e,g);if(g.limitConcurrentUploads&&g.limitConcurrentUploads>k._sending){var m=k._slots.shift();while(m){if(k._getDeferredState(m)==="pending"){m.resolve();break}m=k._slots.shift()}}});return f};this._beforeSend(d,g);if(this.options.sequentialUploads||(this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending)){if(this.options.limitConcurrentUploads>1){j=a.Deferred();this._slots.push(j);h=j.pipe(i)}else{h=(this._sequence=this._sequence.pipe(i,i))}h.abort=function(){b=[undefined,"abort","abort"];if(!f){if(j){j.rejectWith(g.context,b)}return i()}return f.abort()};return this._enhancePromise(h)}return i()},_onAdd:function(c,b){var n=this,m=true,h=a.extend({},this.options,b),g=h.limitMultiFileUploads,j=this._getParamName(h),k,l,d,f;if(!(h.singleFileUploads||g)||!this._isXHRUpload(h)){d=[b.files];k=[j]}else{if(!h.singleFileUploads&&g){d=[];k=[];for(f=0;f<b.files.length;f+=g){d.push(b.files.slice(f,f+g));l=j.slice(f,f+g);if(!l.length){l=j}k.push(l)}}else{k=j}}b.originalFiles=b.files;a.each(d||b.files,function(i,e){var o=a.extend({},b);o.files=d?e:[e];o.paramName=k[i];n._initProgressObject(o);n._addConvenienceMethods(c,o);m=n._trigger("add",c,o);return m});return m},_replaceFileInput:function(b){var c=b.clone(true);a("<form></form>").append(c)[0].reset();b.after(c).detach();a.cleanData(b.unbind("remove"));this.options.fileInput=this.options.fileInput.map(function(e,d){if(d===b[0]){return c[0]}return d});if(b[0]===this.element[0]){this.element=c}},_handleFileTreeEntry:function(d,f){var g=this,b=a.Deferred(),e=function(h){if(h&&!h.entry){h.entry=d}b.resolve([h])},c;f=f||"";if(d.isFile){if(d._file){d._file.relativePath=f;b.resolve(d._file)}else{d.file(function(h){h.relativePath=f;b.resolve(h)},e)}}else{if(d.isDirectory){c=d.createReader();c.readEntries(function(h){g._handleFileTreeEntries(h,f+d.name+"/").done(function(i){b.resolve(i)}).fail(e)},e)}else{b.resolve([])}}return b.promise()},_handleFileTreeEntries:function(b,c){var d=this;return a.when.apply(a,a.map(b,function(e){return d._handleFileTreeEntry(e,c)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(b){b=b||{};var c=b.items;if(c&&c.length&&(c[0].webkitGetAsEntry||c[0].getAsEntry)){return this._handleFileTreeEntries(a.map(c,function(e){var d;if(e.webkitGetAsEntry){d=e.webkitGetAsEntry();if(d){d._file=e.getAsFile()}return d}return e.getAsEntry()}))}return a.Deferred().resolve(a.makeArray(b.files)).promise()},_getSingleFileInputFiles:function(c){c=a(c);var b=c.prop("webkitEntries")||c.prop("entries"),d,e;if(b&&b.length){return this._handleFileTreeEntries(b)}d=a.makeArray(c.prop("files"));if(!d.length){e=c.prop("value");if(!e){return a.Deferred().resolve([]).promise()}d=[{name:e.replace(/^.*\\/,"")}]}else{if(d[0].name===undefined&&d[0].fileName){a.each(d,function(g,f){f.name=f.fileName;f.size=f.fileSize})}}return a.Deferred().resolve(d).promise()},_getFileInputFiles:function(b){if(!(b instanceof a)||b.length===1){return this._getSingleFileInputFiles(b)}return a.when.apply(a,a.map(b,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_onChange:function(c){var d=this,b={fileInput:a(c.target),form:a(c.target.form)};this._getFileInputFiles(b.fileInput).always(function(e){b.files=e;if(d.options.replaceFileInput){d._replaceFileInput(b.fileInput)}if(d._trigger("change",c,b)!==false){d._onAdd(c,b)}})},_onPaste:function(d){var b=d.originalEvent.clipboardData,f=(b&&b.items)||[],c={files:[]};a.each(f,function(g,h){var e=h.getAsFile&&h.getAsFile();if(e){c.files.push(e)}});if(this._trigger("paste",d,c)===false||this._onAdd(d,c)===false){return false}},_onDrop:function(d){var f=this,c=d.dataTransfer=d.originalEvent.dataTransfer,b={};if(c&&c.files&&c.files.length){d.preventDefault()}this._getDroppedFiles(c).always(function(e){b.files=e;if(f._trigger("drop",d,b)!==false){f._onAdd(d,b)}})},_onDragOver:function(c){var b=c.dataTransfer=c.originalEvent.dataTransfer;if(this._trigger("dragover",c)===false){return false}if(b&&a.inArray("Files",b.types)!==-1){b.dropEffect="copy";c.preventDefault()}},_initEventHandlers:function(){if(this._isXHRUpload(this.options)){this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop});this._on(this.options.pasteZone,{paste:this._onPaste})}this._on(this.options.fileInput,{change:this._onChange})},_destroyEventHandlers:function(){this._off(this.options.dropZone,"dragover drop");this._off(this.options.pasteZone,"paste");this._off(this.options.fileInput,"change")},_setOption:function(b,d){var c=a.inArray(b,this._refreshOptionsList)!==-1;if(c){this._destroyEventHandlers()}this._super(b,d);if(c){this._initSpecialOptions();this._initEventHandlers()}},_initSpecialOptions:function(){var b=this.options;if(b.fileInput===undefined){b.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]')}else{if(!(b.fileInput instanceof a)){b.fileInput=a(b.fileInput)}}if(!(b.dropZone instanceof a)){b.dropZone=a(b.dropZone)}if(!(b.pasteZone instanceof a)){b.pasteZone=a(b.pasteZone)}},_create:function(){var b=this.options;a.extend(b,a(this.element[0].cloneNode(false)).data());this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=0;this._initProgressObject(this);this._initEventHandlers()},progress:function(){return this._progress},add:function(b){var c=this;if(!b||this.options.disabled){return}if(b.fileInput&&!b.files){this._getFileInputFiles(b.fileInput).always(function(d){b.files=d;c._onAdd(null,b)})}else{b.files=a.makeArray(b.files);this._onAdd(null,b)}},send:function(c){if(c&&!this.options.disabled){if(c.fileInput&&!c.files){var g=this,d=a.Deferred(),f=d.promise(),e,b;f.abort=function(){b=true;if(e){return e.abort()}d.reject(null,"abort","abort");return f};this._getFileInputFiles(c.fileInput).always(function(h){if(b){return}c.files=h;e=g._onSend(null,c).then(function(j,k,i){d.resolve(j,k,i)},function(j,k,i){d.reject(j,k,i)})});return this._enhancePromise(f)}c.files=a.makeArray(c.files);if(c.files.length){return this._onSend(null,c)}}return this._getXHRPromise(false,c&&c.context)}})}));